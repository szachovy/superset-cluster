---
name: "Tests"

on:  # yamllint disable-line rule:truthy
  push:
    branches: "**"

env:
  TERRAFORM_WORKING_DIRECTORY: "./tests/setup"
  ANSIBLE_WORKING_DIRECTORY: "./tests/testsuite"

jobs:
  tests:
    runs-on: "self-hosted"
    steps:
      - uses: "actions/checkout@v4"
      - uses: "actions/setup-node@v3"
        with:
          node-version: "20"
      - uses: "hashicorp/setup-terraform@v3"
        with:
          terraform_version: "1.0.10"
      - uses: "actions/setup-python@v3"
        id: cpython310
        with:
          python-version: "3.10.12"

      - name: "Install Python dependencies"
        run: "pip install --no-cache-dir --user ansible==9.5.1 paramiko==3.5.0"

      - name: "Initialize Terraform infrastructure"
        run: "terraform init"
        working-directory: "${{ env.TERRAFORM_WORKING_DIRECTORY }}"

      - name: "Apply Terraform infrastructure"
        run: "terraform apply --auto-approve"
        working-directory: "${{ env.TERRAFORM_WORKING_DIRECTORY }}"

      - name: "Run Ansible testsuite"
        run: "ansible-playbook --inventory inventory.yml deploy.yml"
        working-directory: ${{ env.ANSIBLE_WORKING_DIRECTORY }}

      - uses: "actions/upload-artifact@v4"
        if: "${{ always() }}"
        with:
          path: "/tmp/superset_cluster_testsuite.log"

      - name: "Destroy Terraform environment"
        run: "terraform destroy --auto-approve"
        if: "${{ always() }}"
        working-directory: "${{ env.TERRAFORM_WORKING_DIRECTORY }}"
