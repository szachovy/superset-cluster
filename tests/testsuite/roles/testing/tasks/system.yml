---
- name: end-to-end run
  ansible.builtin.shell: |
    set -euxo pipefail
    {
      source {{ role_path }}/files/system.sh \
        {{ node_prefix }} \
        {{ superset_network_interface }} \
        {{ virtual_ip_address }} \
        {{ virtual_ip_address_mask }} \
        {{ virtual_network_interface }}
      clusterize_nodes
      initialize_nodes
      start_superset
    } | tee /tmp/superset_cluster_testsuite.log
  args:
    executable: /bin/bash
  async: 1200
  poll: 60

- name: Check superset container status
  ansible.builtin.shell: |
    /bin/bash -c '
    while [ "$(docker service ls --filter "name=superset" --format "{{.Replicas}}")" != "1/1" ]; do
      echo "Waiting for superset container to become healthy..."
      exit 1
    done'
  retries: 6
  delay: 50
