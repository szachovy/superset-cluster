---
- name: end-to-end run
  ansible.builtin.shell: |
    set -euxo pipefail
    {
      source {{ role_path }}/files/system.sh \
        {{ node_prefix }} \
        {{ superset_network_interface }} \
        {{ virtual_ip_address }} \
        {{ virtual_ip_address_mask }} \
        {{ virtual_network_interface }}
      clusterize_nodes
      initialize_nodes
      start_superset
    } | tee /tmp/superset_cluster_testsuite.log
  args:
    executable: /bin/bash

- name: Check superset container status
  community.docker.docker_container_exec:
    container: "{{ node_prefix }}-0"
    command: |
      /bin/bash -c '
      while [ "$(docker inspect superset | jq -r .[0].State.Health.Status)" != "healthy" ]; do
        echo "Waiting for superset container to become healthy..."
        exit 1
      done'
  retries: 6
  delay: 50
