---
- name: Get infos on network
  community.docker.docker_network_info:
    name: node-network
    timeout: 10
  register: result
  failed_when:
    - "result.exists == false"
    # do more

- name: Get infos on container
  community.docker.docker_container_info:
    name: "{{ container.value['Name'] }}"
  register: node
  loop: "{{ result.network.Containers | dict2items }}"
  loop_control:
    loop_var: container
  failed_when:
    - container.value['Name'] != node.container.Config.Hostname
    - node.container.State.Running == false
    # do more

- name: copy
  community.docker.docker_container_copy_into:
    container: "{{ container.value['Name'] }}"
    path: "{{ role_path }}/files/introspect.py"
    container_path: "/opt/superset-cluster/src/introspect.py"
  loop: "{{ result.network.Containers | dict2items }}"
  loop_control:
    loop_var: container
  register: service_status

- name: introspect docker containers
  community.docker.docker_container_exec:
    container: "{{ container.value['Name'] }}"
    command: "python3 /opt/superset-cluster/src/introspect.py
      --nodes {{ nodes }}
      --node-prefix {{ node_prefix }}
      --network-interface {{ network_interface }}"
  loop: "{{ result.network.Containers | dict2items }}"
  loop_control:
    loop_var: container
  register: service_status

- name: check passwordless ssh
  ansible.builtin.shell: "ssh root@{{ container.value['Name'] }} exit"
  loop: "{{ result.network.Containers | dict2items }}"
  loop_control:
    loop_var: container
  register: ssh_result
  failed_when: ssh_result.rc != 0
